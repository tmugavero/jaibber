# Connecting a Claude Code Agent to Jaibber

This guide explains how to configure a Claude Code agent to connect to and coordinate through the Jaibber hub.

## Prerequisites

1. **Jaibber hub running** — open the Jaibber desktop app and complete the setup wizard
2. **Tailscale installed** on the agent machine — install from [tailscale.com/download](https://tailscale.com/download)
3. **Same Tailnet** — the agent machine must be in the same Tailscale network as the hub

## Step 1: Join the Tailnet

```bash
tailscale up
```

Confirm the agent machine appears in your Tailnet. The hub's Tailscale IP is shown in the Jaibber dashboard (top bar).

## Step 2: Set Environment Variables

```bash
export ANTHROPIC_API_KEY="sk-ant-..."
export JAIBBER_HUB_IP="100.x.x.x"        # Hub's Tailscale IP from dashboard
export JAIBBER_AGENT_ID="agent-a"          # or "agent-b"
export JAIBBER_MCP_ENDPOINT="http://${JAIBBER_HUB_IP}:3456/mcp"
```

## Step 3: Configure Claude Code with the MCP Server

Create or update your Claude Code MCP configuration to point to the Jaibber hub:

```json
{
  "mcpServers": {
    "jaibber": {
      "url": "http://100.x.x.x:3456/mcp",
      "type": "http"
    }
  }
}
```

Or via CLI:
```bash
claude mcp add jaibber --url "http://${JAIBBER_HUB_IP}:3456/mcp"
```

## Step 4: Available MCP Tools

Once connected, Claude Code agents have access to these coordination tools:

| Tool | Description |
|------|-------------|
| `get_task` | Dequeue the next pending task from the hub's task queue |
| `claim_lock` | Atomically lock a file path so the peer agent won't edit it |
| `release_lock` | Release a previously claimed file lock |
| `send_message` | Publish a message to any NATS subject (peer-to-peer messaging) |
| `get_peer_status` | Check the status and current task of the peer agent |

## Step 5: Register the Agent

When an agent starts, it should register its MCP endpoint by publishing to NATS:

```bash
# Using the NATS CLI (nats-cli)
nats pub mcp.register '{"agentId":"agent-a","endpoint":"http://AGENT_IP:3457/mcp","tools":["get_task","claim_lock","release_lock","send_message","get_peer_status"]}'
```

## Workflow Pattern

```
Agent A                    Hub                       Agent B
  |                         |                           |
  |-- get_task() ---------->|                           |
  |<-- {task: "..."}        |                           |
  |                         |                           |
  |-- claim_lock(file.rs) ->|                           |
  |<-- {success: true}      |-- lock:acquired event --> dashboard
  |                         |                           |
  | [edits file.rs]         |                           |
  |                         |                           |
  |-- release_lock(file.rs)->|                          |
  |                         |-- lock:released event --> dashboard
  |                         |                           |
  |-- send_message(agents.agent-a.task.complete, ...) ->|
  |                         |<-- agent-b picks up       |
```

## NATS Direct Connection

Agents can also connect directly to the NATS server for lower-level messaging:

```
nats://100.x.x.x:4222
```

Use the credentials file generated by the hub (Settings > NATS > Export Credentials).

## Monitoring

Open the Jaibber dashboard to see:
- Agent connection status (Dashboard screen)
- Live message stream (Relay Log screen)
- Task queue state (Tasks screen)
- File lock registry (Dashboard — AgentCard)
- Git branch activity (Git Activity screen)
